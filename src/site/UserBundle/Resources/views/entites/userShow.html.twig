{% extends 'LaboAdminBundle::page_admin_generic.html.twig' %}
{% set cssjsloads = 'TAB' %}
{% set DEVMODE = (app.environment in ['DEV', 'TEST']) or (is_granted('ROLE_SUPER_ADMIN')) %}

{% block page_heading %}
<div class="row wrapper border-bottom white-bg page-heading">
	<div class="col-lg-12 m-t-xs">
		<h2 class="row">
			<div class="col-md-8 ellipsis">{{ htitle|capitalize }}</div>
			<div class="col-md-4">
				{% if app.user.haveRight(user) %}
				<a href="{{ path('siteUser_edit', {username: user.username}) }}" type="button" class="btn btn-xs btn-warning pull-right"><i class="fa fa-pencil icon-wait-on-click"></i> Modifier</a>
				<a href="{{ path('siteUser_delete', {username: user.username}) }}" type="button" class="btn btn-xs btn-danger btn-outline pull-right need-confirmation" title="Supprimer {{ user.username }}" data-message="Souhaitez-vous vraiment supprimer ce compte ?"><i class="fa fa-times icon-wait-on-click"></i> Supprimer</a>
				{% endif %}
			</div>
		</h2>
		<ol class="breadcrumb">
			<li><a href="{{ path('siteadmin_homepage') }}"><strong>Administration</strong></a></li>
			<li><a href="{{ path('siteUser_users', {type: 'all'}) }}"><strong>Utilisateurs</strong></a></li>
			<li>{{ user.username }}{% if user.id == app.user.id %} <em class="text-muted">(moi-même)</em>{% endif %}</li>
		</ol>
	</div>
</div>
{% endblock page_heading %}

{% block content %}
{%  if app.user.haveRight(user) %}
<div class="row m-b-lg m-t-xs">
	<div class="col-md-6">

		<div class="profile-image">
			{% if user.avatar|default(null) != null %}
			<img src="{{ user.avatar.imgThumbnail(128,128,'cut')|raw }}" class="img-circle circle-border m-b-md" alt="profile">
			{% else %}
			<i class="fa fa-user fa-5x m-b-md text-{{ userColor(user) }}" alt="profile"></i>
			{% endif %}
		</div>
		<div class="profile-info">
			<div class="">
				<div>
					<h2 class="no-margins ellipsis">
						{{ user.nom|default(user.username) }} {{ user.prenom|default('') }}
					</h2>
					<h4>
						{% for role in user.roles %}
						<div class="label label-{{ roleColors[role] }}">{{ roleNames[role] }}</div> 
						{% endfor %}
					</h4>
					<!-- <small> -->
						<!-- There are many variations of passages of Lorem Ipsum available, but the majority -->
						<!-- have suffered alteration in some form Ipsum available. -->
					<!-- </small> -->
				</div>
			</div>
		</div>
	</div>
	<br class="visible-xs">
	<div class="col-md-6">
		<table class="table small m-b-xs">
			<tbody>
				<tr>
					<td{% if user.lastLogin is not null %} title="{{ user.lastLogin|date(formatDateHeure) }}"{% endif %}>
						<strong>Login</strong> 
						{% if user.lastLogin is not null %}
						{{ dateFR(user.lastLogin, true)|raw }} {{ user.lastLogin|date('H\\hi')|raw }}
						{% else %}
						<i class="text-muted">(jamais)</i>
						{% endif %}
					</td>
					<td>
						<p></p>
					</td>
					<td>
						<strong>Messages</strong> {{ user.messages(true)|length }}
					</td>
				</tr>
				{% if marketplace.active|default(false) %}
				<tr>
					<td>
						{% if marketplace.active|default(false) %}
						<strong>Panier</strong> {% if user.articlesPanier|default(0) > 0 %}{{ user.articlesPanier }}{% else %}(vide){% endif %}
						{% endif %}
					</td>
					<td>
						<strong>Achats</strong> {{ factures|default([])|length }}
					</td>
					<td title="{{ cumulHT|default(0)|number_format(2, ',', '') }} {{ marketplace.devises[app.request.locale].symb }}HT">
						<strong>Total</strong> {{ cumulTTC|default(0)|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}{{ UCfirst('fields.TTC'|trans({}, 'tauxTva')) }}
					</td>
				</tr>
				{% endif %}
			</tbody>
		</table>
	</div>

	<div class="clearfix"></div>

	<div class="col-md-6 col-lg-4">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<h2>Coordonnées <small>{{ user.username }}</small></h2>
				<hr>
				<table class="table table-striped table-bordered table-hover">
					<thead>
						<tr>
							<th>Libellé</th>
							<th>valeurs</th>
						</tr>
					</thead>
					<tbody>
						{% if user.adresse is defined %}
						<tr>
							<td><strong>Adresse</strong></td>
							<td>{{ user.adresse|default('-') }}<br>{{ user.cp|default('-') }} {{ user.ville|default('-') }}</td>
						</tr>
						{% endif %}
						<tr>
							<td><strong>Email</strong></td>
							<td title="{{ user.email }}"><a href="mailto:{{ user.email }}">{{ phraseCut(user.email, 22) }}</a></td>
						</tr>
						<tr>
							<td><strong>Téléphone</strong></td>
							<td>{{ user.telephone }}</td>
						</tr>
						<tr>
							<td><strong>Last login</strong></td>
							{% if user.lastLogin is not null %}
							<td>{{ user.lastLogin|date(formatDateHeure) }}</td>
							{% else %}
							<td>-</td>
							{% endif %}
						</tr>
						<tr>
							<td><strong>Last password request</strong></td>
							{% if user.passwordRequestedAt is not null %}
							<td>{{ user.passwordRequestedAt|date(formatDateHeure) }}</td>
							{% else %}
							<td>-</td>
							{% endif %}
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	{% if marketplace.active|default(false) %}
	<div class="col-md-6 col-lg-4">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<h2>Panier <small>{{ user.username }}</small> <div class="label label-info">{{ user.articlesPanier|default(0) }}</div></h2>
				<p class="adminhelp"><small>Contenu actuel du panier de <strong>{{ user.username }}</strong>.</small></p>
				<hr>
				{% if user.paniers|length > 0 %}
				<p><strong>{{ user.paniers|length }}</strong> article{{ plur(user.paniers) }} différent{{ plur(user.paniers) }}</p>
				<table class="table table-striped table-bordered table-hover">
					<tbody>
						<tr>
							<!-- <td><strong>Contenu</strong></td> -->
							<td>
								<table class="table small m-b-xs">
									<tbody>
										<tr>
											<td><strong>Article</strong></td>
											<td><strong>Q.</strong></td>
											<td><strong>Prix<sup>{{ UCfirst('fields.TTC'|trans({}, 'tauxTva')) }}</sup></strong></td>
											<td><strong>Total<sup>{{ UCfirst('fields.TTC'|trans({}, 'tauxTva')) }}</sup></strong></td>
										</tr>
										{% set totalpanierTTC = 0 %}
										{% set totalpanierHT = 0 %}
										{% for panier in user.paniers %}
										{% set totalpanierTTC = totalpanierTTC + (panier.article.prix * panier.quantite) %}
										{% set totalpanierHT = totalpanierHT + (panier.article.prixHT * panier.quantite) %}
										<tr>
											<td><a href="{{ path('siteadmin_entite', {entite: 'article', id: panier.article.id, action: 'show'}) }}" title="{{ dateFR(panier.updated|default(panier.created)) }} {{ panier.updated|default(panier.created)|date('H:i:s') }}">{{ panier.article.nom }}</a></td>
											<td>x&nbsp;{{ panier.quantite }}</td>
											<td>{{ panier.article.prix|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}</td>
											<td>{{ (panier.quantite * panier.article.prix)|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}</td>
										</tr>
										{% endfor %}
										<tr style="border-top: 2px solid #bbb;">
											<td colspan="3"><strong>Total {{ UCfirst('fields.TTC'|trans({}, 'tauxTva')) }}</strong></td>
											<td><strong>{{ totalpanierTTC|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}</strong></td>
										</tr>
										<tr>
											<td colspan="3"><em>Total HT</em></td>
											<td><em>{{ totalpanierHT|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}</em></td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
				{% else %}
				<p>Panier vide</p>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="clearfix hidden-lg"></div>
	{% endif %}

	{% if marketplace.active|default(false) %}
	<div class="col-md-6 col-lg-4">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<h2>Factures / Achats <small>{{ user.username }}</small> <div class="label label-info">{{ factures|default([])|length }}</div></h2>
				<p class="adminhelp"><small>Liste des factures d'achats de <strong>{{ user.username }}</strong>.</small></p>
				<hr>
				{% if factures|default([])|length > 0 %}
				<table class="table table-striped table-bordered table-hover">
					<tbody>
						{% for facture in factures|default({}) %}
						<tr>
							<td colspan="2"><a href="{{ path('labo_vente_show', {id: facture.id}) }}"><strong>{{ facture.reference }}</strong></a></td>
						</tr>
						<tr>
							<td colspan="2">
								<table class="table small m-b-xs">
									<tbody>
										<tr>
											<td class="text-center"><strong>Nb.Art.</strong></td>
											<td><strong>Total<sup>{{ UCfirst('fields.TTC'|trans({}, 'tauxTva')) }}</sup></strong></td>
											<td><strong>Statut</strong></td>
										</tr>
										<tr>
											<td class="text-center">{{ facture.nbArticles }}</td>
											<td>{{ facture.prixtotal|number_format(2, ',', '') }}&nbsp;{{ marketplace.devises[app.request.locale].symb }}</td>
											<td>
												{% if facture.stade == 100 %}{% set color = 'danger' %}
												{% elseif facture.stade == 3 %}{% set color = 'warning' %}
												{% elseif facture.stade < 2 %}{% set color = 'info' %}
												{% else %}{% set color = 'success' %}
												{% endif %}
												<p class="text-{{ color }}">{{ facture.stadeTxt }}</p>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
				{% else %}
				<p>Aucun achat</p>
				{% endif %}
			</div>
		</div>
	</div>
	{% endif %}

	<hr>

	<div class="col-md-12 col-lg-6">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<h2>Messages <small>{{ user.username }}</small> <div class="label label-info">{{ user.messages(true)|length }}</div></h2>
				<p class="adminhelp"><small>Liste des messages de <strong>{{ user.username }}</strong> | <a href="{{ path('siteadmin_entite', {entite: 'message'}) }}">Consulter messagerie</a></small></p>
				<hr>
				{% if user.messages(true)|length > 0 %}
				<table class="table table-striped table-bordered table-hover">
					<tbody>
						{% for message in user.messages(true)|default({}) %}
						<tr>
							<td>{{ message.position }} | <strong>{{ message.objet|default('<i class="fa fa-ban text-muted"></i>')|raw }}</strong></td>
						</tr>
						<tr>
							<td>
								<blockquote>
									<p>{{ message.message|nl2br|raw }}</p>
									<small>
										<strong><a href="mailto:{{ user.email }}">Répondre</a></strong> - <cite>{{ message.creation|date(formatDateHeure) }}</cite>
									</small>
								</blockquote>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
				{% else %}
				<p>Aucun Message</p>
				{% endif %}
			</div>
		</div>
	</div>


</div>

{% else %}

<div class="row">
	<div class="col-md-12">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<h3><i class="fa fa-ban"></i> Vous n'avez les droits requis pour accéder au profil de cet utilisateur.</h3>
			</div>
		</div>
	</div>
</div>
{% endif %}

{% endblock content %}